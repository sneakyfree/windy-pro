<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Windy Pro Setup</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0F172A;
      color: #E2E8F0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .wizard { flex: 1; display: flex; flex-direction: column; padding: 28px 32px 20px; }
    .step { display: none; flex: 1; flex-direction: column; min-height: 0; overflow: hidden; }
    .step.active { display: flex; }

    h1 { font-size: 22px; margin-bottom: 6px; }
    .subtitle { font-size: 14px; color: #94A3B8; margin-bottom: 20px; }

    /* Progress bar */
    .progress-track {
      display: flex; gap: 6px; margin-bottom: 24px;
    }
    .progress-dot {
      flex: 1; height: 3px; border-radius: 2px;
      background: #1E293B; transition: background 0.3s;
    }
    .progress-dot.done { background: #22C55E; }
    .progress-dot.active { background: #86EFAC; }

    /* Buttons */
    .btn-row { display: flex; gap: 10px; justify-content: flex-end; flex-shrink: 0; margin-top: 0; padding-top: 16px; border-top: 1px solid #1E293B; }
    .btn {
      padding: 10px 24px; border-radius: 8px; border: none;
      font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.15s;
    }
    .btn-primary { background: #22C55E; color: #0F172A; }
    .btn-primary:hover { background: #16A34A; }
    .btn-primary:disabled { background: #374151; color: #6B7280; cursor: not-allowed; }
    .btn-secondary { background: #1E293B; color: #94A3B8; }
    .btn-secondary:hover { background: #334155; color: #E2E8F0; }

    /* Welcome screen */
    .logo { font-size: 48px; margin-bottom: 12px; }
    .welcome-text { font-size: 15px; color: #CBD5E1; line-height: 1.6; margin-bottom: 16px; }
    .feature-list { list-style: none; display: flex; flex-direction: column; gap: 8px; }
    .feature-list li { display: flex; align-items: center; gap: 10px; font-size: 14px; color: #94A3B8; }
    .feature-list li::before { content: '‚úì'; color: #22C55E; font-weight: 700; }

    /* Scan screen */
    .scan-status {
      background: #1E293B; border-radius: 12px; padding: 20px;
      display: flex; flex-direction: column; gap: 12px; flex: 1;
    }
    .scan-row { display: flex; justify-content: space-between; align-items: center; }
    .scan-label { font-size: 13px; color: #94A3B8; }
    .scan-value { font-size: 13px; font-weight: 600; color: #E2E8F0; }
    .scan-value.good { color: #22C55E; }
    .scan-value.warn { color: #F59E0B; }
    .scan-spinner { font-size: 13px; color: #64748B; }
    .connection-badge {
      background: #0F172A; border-radius: 8px; padding: 10px 14px;
      display: flex; align-items: center; gap: 10px; margin-top: 4px;
    }
    .connection-icon { font-size: 20px; }
    .connection-info { flex: 1; }
    .connection-speed { font-size: 14px; font-weight: 700; color: #22C55E; }
    .connection-note { font-size: 11px; color: #64748B; margin-top: 1px; }

    /* Model picker ‚Äî compact rows, no layout-shifting expansion */
    .model-section { display: flex; flex-direction: column; flex: 1; min-height: 0; gap: 8px; }
    .model-list { display: flex; flex-direction: column; gap: 4px; flex-shrink: 0; }
    .model-row {
      display: flex; align-items: center; gap: 12px;
      background: #1E293B; border-radius: 8px; padding: 10px 14px;
      border: 2px solid transparent; cursor: pointer; transition: all 0.15s;
      user-select: none;
    }
    .model-row:hover { border-color: #334155; background: #243347; }
    .model-row.selected { border-color: #22C55E; background: #162B1F; }
    .model-row.unavailable { opacity: 0.45; cursor: not-allowed; }
    .model-chk {
      width: 18px; height: 18px; border-radius: 4px; border: 2px solid #475569;
      flex-shrink: 0; display: flex; align-items: center; justify-content: center;
      transition: all 0.15s; font-size: 11px; font-weight: 800; color: #0F172A;
    }
    .model-row.selected .model-chk { background: #22C55E; border-color: #22C55E; }
    .model-row-name { font-size: 14px; font-weight: 700; flex-shrink: 0; min-width: 56px; }
    .model-row-badge { font-size: 10px; background: #1E3A2F; color: #4ADE80; padding: 2px 7px; border-radius: 20px; flex-shrink: 0; }
    .model-row-desc { font-size: 12px; color: #94A3B8; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .model-row-meta { display: flex; gap: 10px; flex-shrink: 0; margin-left: auto; padding-left: 8px; }
    .meta-size { font-size: 11px; color: #64748B; }
    .meta-time { font-size: 11px; color: #F59E0B; font-weight: 600; }
    .meta-ram  { font-size: 11px; color: #64748B; }

    /* Fixed detail panel ‚Äî never changes height, updates on hover/select */
    .model-detail-panel {
      background: #1E293B; border-radius: 8px; padding: 12px 14px;
      flex-shrink: 0; min-height: 90px;
      border: 1px solid #334155;
    }
    .mdp-title { font-size: 13px; font-weight: 700; color: #E2E8F0; margin-bottom: 6px; }
    .mdp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 16px; }
    .mdp-pro  { font-size: 11px; color: #4ADE80; }
    .mdp-pro::before  { content: '+ '; }
    .mdp-con  { font-size: 11px; color: #F87171; }
    .mdp-con::before  { content: '‚àí '; }
    .mdp-best { font-size: 11px; color: #94A3B8; margin-top: 6px; }
    .mdp-best span { color: #CBD5E1; }
    .mdp-empty { font-size: 12px; color: #475569; line-height: 1.5; }

    /* Summary bar above Install button */
    .model-summary { font-size: 12px; color: #94A3B8; text-align: right; padding-top: 6px; flex-shrink: 0; }

    /* Install screen */
    .install-wrap { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 16px; }
    .install-status { font-size: 15px; color: #E2E8F0; text-align: center; }
    .install-detail { font-size: 13px; color: #64748B; text-align: center; }
    .progress-bar-wrap { background: #1E293B; border-radius: 8px; height: 10px; overflow: hidden; }
    .progress-bar-fill {
      height: 100%; background: linear-gradient(90deg, #22C55E, #86EFAC);
      border-radius: 8px; transition: width 0.4s ease; width: 0%;
    }
    .progress-steps { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
    .progress-step-item { display: flex; align-items: center; gap: 10px; font-size: 13px; color: #475569; }
    .progress-step-item.done { color: #22C55E; }
    .progress-step-item.active { color: #E2E8F0; }
    .step-icon { font-size: 16px; width: 20px; text-align: center; }

    /* Done screen */
    .done-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; }
    .done-icon { font-size: 56px; }
    .done-title { font-size: 22px; font-weight: 700; color: #22C55E; }
    .done-desc { font-size: 14px; color: #94A3B8; text-align: center; max-width: 340px; line-height: 1.5; }
    .done-models { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; }
    .done-model-tag { background: #162B1F; color: #4ADE80; border-radius: 20px; padding: 4px 12px; font-size: 12px; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1E293B; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #4A5568; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748B; }
  </style>
</head>
<body>
<div class="wizard">

  <!-- Progress dots -->
  <div class="progress-track">
    <div class="progress-dot active" id="dot-0"></div>
    <div class="progress-dot" id="dot-1"></div>
    <div class="progress-dot" id="dot-2"></div>
    <div class="progress-dot" id="dot-3"></div>
  </div>

  <!-- STEP 0: Welcome -->
  <div class="step active" id="step-0">
    <div class="logo">üå™Ô∏è</div>
    <h1>Welcome to Windy Pro</h1>
    <p class="subtitle">Voice-to-text that never stops. The Green Strobe never lies.</p>
    <p class="welcome-text">
      This wizard will set up everything you need ‚Äî takes about 2‚Äì5 minutes depending on your internet speed and which model you choose.
    </p>
    <ul class="feature-list">
      <li>Unlimited recording ‚Äî no 5-minute cutoff</li>
      <li>Green Strobe = recording. Always. No guessing.</li>
      <li>100% local ‚Äî your words never leave your machine</li>
      <li>Works anywhere you can type</li>
    </ul>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="goToStep(1)">Get Started ‚Üí</button>
    </div>
  </div>

  <!-- STEP 1: Hardware Scan -->
  <div class="step" id="step-1">
    <h1>Scanning your machine‚Ä¶</h1>
    <p class="subtitle" id="scan-subtitle">Checking hardware and internet speed</p>
    <div class="scan-status" id="scan-results">
      <div class="scan-row"><span class="scan-label">CPU</span><span class="scan-value scan-spinner" id="scan-cpu">Detecting‚Ä¶</span></div>
      <div class="scan-row"><span class="scan-label">RAM</span><span class="scan-value scan-spinner" id="scan-ram">Detecting‚Ä¶</span></div>
      <div class="scan-row"><span class="scan-label">GPU</span><span class="scan-value scan-spinner" id="scan-gpu">Detecting‚Ä¶</span></div>
      <div class="scan-row"><span class="scan-label">Storage</span><span class="scan-value scan-spinner" id="scan-disk">Detecting‚Ä¶</span></div>
      <div class="connection-badge" id="conn-badge" style="display:none">
        <div class="connection-icon">üì°</div>
        <div class="connection-info">
          <div class="connection-speed" id="conn-speed">‚Äî</div>
          <div class="connection-note" id="conn-note">Measuring download speed‚Ä¶</div>
        </div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goToStep(0)">Back</button>
      <button class="btn btn-primary" id="btn-to-models" disabled onclick="goToStep(2)">Choose Models ‚Üí</button>
    </div>
  </div>

  <!-- STEP 2: Model Picker -->
  <div class="step" id="step-2">
    <h1>Choose your models</h1>
    <p class="subtitle" id="model-subtitle">Select one or more ‚Äî hover a row to see details</p>
    <div class="model-section">
      <div class="model-list" id="model-grid"><!-- populated by JS --></div>
      <div class="model-detail-panel" id="model-detail">
        <div class="mdp-empty">Hover or select a model to see details.</div>
      </div>
    </div>
    <div class="model-summary" id="model-summary"></div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goToStep(1)">Back</button>
      <button class="btn btn-primary" id="btn-install" disabled onclick="startInstall()">Install ‚Üí</button>
    </div>
  </div>

  <!-- STEP 3: Installing -->
  <div class="step" id="step-3">
    <h1>Installing‚Ä¶</h1>
    <p class="subtitle">Sit tight ‚Äî setting everything up</p>
    <div class="install-wrap">
      <div class="progress-bar-wrap"><div class="progress-bar-fill" id="progress-fill"></div></div>
      <div class="install-status" id="install-status">Starting‚Ä¶</div>
      <div class="install-detail" id="install-detail"></div>
      <div class="progress-steps">
        <div class="progress-step-item" id="ps-venv"><span class="step-icon">üêç</span> Creating Python environment</div>
        <div class="progress-step-item" id="ps-deps"><span class="step-icon">üì¶</span> Installing transcription engine</div>
        <div class="progress-step-item" id="ps-model"><span class="step-icon">üß†</span> Downloading AI model</div>
        <div class="progress-step-item" id="ps-done"><span class="step-icon">‚úÖ</span> Finishing up</div>
      </div>
    </div>
  </div>

  <!-- STEP 4: Done -->
  <div class="step" id="step-4">
    <div class="done-wrap">
      <div class="done-icon">üü¢</div>
      <div class="done-title">You're all set!</div>
      <div class="done-models" id="done-models"></div>
      <div class="done-desc">
        Windy Pro is ready. The Green Strobe means it's recording ‚Äî always.
        Click Launch to start transcribing.
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="launchApp()">Launch Windy Pro üéôÔ∏è</button>
    </div>
  </div>

</div>

<script>
  // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let hardwareData = null;
  let allModels = [];
  let selectedModelIds = [];
  let currentStep = 0;

  // ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function goToStep(n) {
    document.querySelectorAll('.step').forEach((s, i) => {
      s.classList.toggle('active', i === n);
    });
    document.querySelectorAll('.progress-dot').forEach((d, i) => {
      d.classList.toggle('done', i < n);
      d.classList.toggle('active', i === n);
    });
    currentStep = n;
    if (n === 1 && !hardwareData) runScan();
  }

  // ‚îÄ‚îÄ Step 1: Hardware Scan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function runScan() {
    document.getElementById('scan-subtitle').textContent = 'Checking hardware and measuring internet speed‚Ä¶';

    try {
      const result = await window.installerAPI.scanHardware();
      hardwareData = result;
      allModels = result.models || [];

      const hw = result.hardware;
      const speed = result.connectionSpeedMBps || 1.0;

      // Update scan rows
      const cpuEl = document.getElementById('scan-cpu');
      cpuEl.textContent = `${hw.cpuModel?.split(' ').slice(0,4).join(' ') || 'Unknown'} (${hw.cpuCores} cores)`;
      cpuEl.className = 'scan-value good';

      const ramEl = document.getElementById('scan-ram');
      ramEl.textContent = `${hw.ram} GB`;
      ramEl.className = `scan-value ${hw.ram >= 8 ? 'good' : 'warn'}`;

      const gpuEl = document.getElementById('scan-gpu');
      if (hw.gpu?.nvidia) {
        gpuEl.textContent = `NVIDIA ${hw.gpu.name} (${hw.gpu.vram}MB VRAM)`;
        gpuEl.className = 'scan-value good';
      } else if (hw.gpu?.appleSilicon) {
        gpuEl.textContent = 'Apple Silicon (unified memory)';
        gpuEl.className = 'scan-value good';
      } else {
        gpuEl.textContent = 'No GPU ‚Äî CPU mode';
        gpuEl.className = 'scan-value warn';
      }

      const diskEl = document.getElementById('scan-disk');
      diskEl.textContent = `${Math.round(hw.diskFree / 1024)} GB free`;
      diskEl.className = 'scan-value good';

      // Connection speed
      const connBadge = document.getElementById('conn-badge');
      connBadge.style.display = 'flex';
      document.getElementById('conn-speed').textContent =
        speed >= 10 ? `${speed.toFixed(1)} MB/s ‚Äî Fast connection üöÄ` :
        speed >= 2  ? `${speed.toFixed(1)} MB/s ‚Äî Good connection` :
                     `${speed.toFixed(1)} MB/s ‚Äî Slow connection (large models will take a while)`;
      document.getElementById('conn-note').textContent =
        `Download time estimates are personalized to your connection`;

      document.getElementById('scan-subtitle').textContent = 'Everything looks good! Ready to choose your models.';
      document.getElementById('btn-to-models').disabled = false;

      // Pre-build model grid
      buildModelGrid();

    } catch (err) {
      document.getElementById('scan-subtitle').textContent = 'Scan failed ‚Äî using defaults';
      document.getElementById('btn-to-models').disabled = false;
    }
  }

  // ‚îÄ‚îÄ Step 2: Model Grid (compact rows) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function buildModelGrid() {
    const grid = document.getElementById('model-grid');
    grid.innerHTML = '';

    const recommendedId = hardwareData?.recommendation?.model || 'base';

    allModels.forEach(model => {
      const row = document.createElement('div');
      row.className = `model-row ${model.unavailable ? 'unavailable' : ''}`;
      row.dataset.id = model.id;

      const sizeLabel = model.size_gb < 1
        ? Math.round(model.size_gb * 1024) + 'MB'
        : model.size_gb + 'GB';

      const badge = model.recommended
        ? `<span class="model-row-badge" style="background:#1E3350;color:#60A5FA">Recommended</span>`
        : model.badge ? `<span class="model-row-badge">${model.badge}</span>` : '';

      row.innerHTML = `
        <div class="model-chk"></div>
        <span class="model-row-name">${model.name}</span>
        ${badge}
        <span class="model-row-desc">${model.description}</span>
        <div class="model-row-meta">
          <span class="meta-size">üíæ ${sizeLabel}</span>
          <span class="meta-time">‚¨á ${model.download_time}</span>
          <span class="meta-ram">üß† ${model.ram_gb}GB</span>
        </div>
      `;

      if (!model.unavailable) {
        row.addEventListener('click', () => toggleModel(model.id));
        row.addEventListener('mouseenter', () => showModelDetail(model));
      }

      grid.appendChild(row);
    });

    // Auto-select recommended
    toggleModel(recommendedId, true);
  }

  function showModelDetail(model) {
    const panel = document.getElementById('model-detail');
    const prosHtml = (model.pros || []).map(p => `<div class="mdp-pro">${p}</div>`).join('');
    const consHtml = (model.cons || []).map(c => `<div class="mdp-con">${c}</div>`).join('');
    panel.innerHTML = `
      <div class="mdp-title">${model.name} ‚Äî ${model.description}</div>
      <div class="mdp-grid">${prosHtml}${consHtml}</div>
      ${model.best_for ? `<div class="mdp-best">Best for: <span>${model.best_for}</span></div>` : ''}
    `;
  }

  function toggleModel(modelId, forceSelect = false) {
    const idx = selectedModelIds.indexOf(modelId);
    if (idx >= 0 && !forceSelect) {
      // Deselect ‚Äî but keep at least one selected
      if (selectedModelIds.length > 1) {
        selectedModelIds.splice(idx, 1);
      }
    } else if (idx < 0) {
      selectedModelIds.push(modelId);
    }
    updateModelCards();
  }

  function updateModelCards() {
    document.querySelectorAll('.model-row').forEach(row => {
      const isSelected = selectedModelIds.includes(row.dataset.id);
      row.classList.toggle('selected', isSelected);
      const chk = row.querySelector('.model-chk');
      if (chk) chk.textContent = isSelected ? '‚úì' : '';
    });

    const totalGB = allModels
      .filter(m => selectedModelIds.includes(m.id))
      .reduce((sum, m) => sum + m.size_gb, 0);

    const speed = hardwareData?.connectionSpeedMBps || 1.0;
    const seconds = (totalGB * 1024) / speed;
    const timeStr = seconds < 60 ? `~${Math.ceil(seconds)}s` :
                    seconds < 3600 ? `~${Math.ceil(seconds/60)} min` : `~${(seconds/3600).toFixed(1)} hr`;

    const subtitle = selectedModelIds.length === 1
      ? `1 model selected ¬∑ ${totalGB < 1 ? Math.round(totalGB*1024)+'MB' : totalGB.toFixed(1)+'GB'} ¬∑ ${timeStr} download`
      : `${selectedModelIds.length} models selected ¬∑ ${totalGB.toFixed(1)}GB total ¬∑ ${timeStr} download`;

    document.getElementById('model-subtitle').textContent = 'Select one or more ‚Äî hover a row to see details';
    const summaryEl = document.getElementById('model-summary');
    if (summaryEl) summaryEl.textContent = subtitle;
    const installBtn = document.getElementById('btn-install');
    installBtn.disabled = selectedModelIds.length === 0;
    installBtn.textContent = `Install ${selectedModelIds.length > 1 ? selectedModelIds.length + ' Models' : 'Model'} ‚Üí`;
  }

  // ‚îÄ‚îÄ Step 3: Install ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function startInstall() {
    goToStep(3);

    // Tell main process which models were selected
    await window.installerAPI.selectModels(selectedModelIds);

    // Listen for progress events
    window.installerAPI.onProgress((data) => {
      const fill = document.getElementById('progress-fill');
      const status = document.getElementById('install-status');
      const detail = document.getElementById('install-detail');

      fill.style.width = data.percent + '%';
      status.textContent = data.message || 'Working‚Ä¶';

      if (data.step === 'venv') {
        setStepActive('ps-venv');
      } else if (data.step === 'deps') {
        setStepDone('ps-venv');
        setStepActive('ps-deps');
      } else if (data.step === 'model') {
        setStepDone('ps-venv'); setStepDone('ps-deps');
        setStepActive('ps-model');
        if (data.modelCount > 1) {
          detail.textContent = `Model ${data.modelIndex + 1} of ${data.modelCount}`;
        }
      }
    });

    const result = await window.installerAPI.install();

    if (result.success) {
      setStepDone('ps-venv'); setStepDone('ps-deps');
      setStepDone('ps-model'); setStepDone('ps-done');
      document.getElementById('progress-fill').style.width = '100%';
      document.getElementById('install-status').textContent = 'All done! ‚úì';

      // Build done screen
      const doneTags = document.getElementById('done-models');
      const installedModels = result.models || selectedModelIds;
      doneTags.innerHTML = installedModels.map(id => {
        const m = allModels.find(x => x.id === id);
        return `<div class="done-model-tag">‚úì ${m?.name || id} model</div>`;
      }).join('');

      setTimeout(() => goToStep(4), 800);
    } else {
      document.getElementById('install-status').textContent = '‚ö† Installation failed';
      document.getElementById('install-detail').textContent = result.error || 'Unknown error';
    }
  }

  function setStepActive(id) {
    const el = document.getElementById(id);
    if (el) el.className = 'progress-step-item active';
  }
  function setStepDone(id) {
    const el = document.getElementById(id);
    if (el) el.className = 'progress-step-item done';
  }

  // ‚îÄ‚îÄ Done ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function launchApp() {
    await window.installerAPI.complete();
  }
</script>
</body>
</html>
